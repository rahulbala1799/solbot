<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Trading Bot</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f0f23;
            color: #e2e8f0;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            color: #cbd5e1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .live-indicator {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        .last-updated {
            position: absolute;
            bottom: 16px;
            left: 16px;
            font-size: 0.7rem;
            color: #64748b;
        }

        .connection-status {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(34, 197, 94, 0.9);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(4px);
        }

        .transaction-buy {
            border-left: 4px solid #10b981;
        }

        .transaction-sell {
            border-left: 4px solid #ef4444;
        }

        .transaction-pump {
            border-left: 4px solid #f59e0b;
        }

        .transaction-monitor {
            border-left: 4px solid #6b7280;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-type {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .transaction-time {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .transaction-signature {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            color: #64748b;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .no-transactions {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <div class="container">
        <div class="header">
            <h1>üöÄ Solana Trading Bot</h1>
            <p>Real-time pump.fun monitoring and automated trading</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="live-indicator"></div>
                <div class="last-updated" id="lastUpdated">Never</div>
                <div class="stat-number" id="totalTransactions">0</div>
                <div class="stat-label">Transactions Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="buyOrders">0</div>
                <div class="stat-label">Buy Orders > 0.2 SOL</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sellOrders">0</div>
                <div class="stat-label">Auto Sells Executed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uptime">0s</div>
                <div class="stat-label">Bot Uptime</div>
            </div>
        </div>

        <!-- Token Configuration -->
        <div class="section">
            <h3 class="section-title">üéØ Token Configuration</h3>
            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
                    <label style="font-weight: 500; color: #f1f5f9; min-width: 120px;">Token Address:</label>
                    <input
                        type="text"
                        id="tokenInput"
                        placeholder="Enter Solana token address..."
                        style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #f1f5f9; font-family: monospace;"
                        value=""
                    />
                    <button
                        id="setTokenBtn"
                        style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;"
                        onmouseover="this.style.background='#5a6fd8'"
                        onmouseout="this.style.background='#667eea'"
                    >
                        Set Token
                    </button>
                </div>
                <div style="font-size: 0.8rem; color: #94a3b8;">
                    Current: <span id="currentToken">Not set</span> |
                    Enter any Solana token address to monitor all transactions
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="section">
            <h3 class="section-title">
                üìä Live Transactions
                <span id="liveStatus" style="font-size: 0.8rem; color: #10b981; font-weight: 400;">
                    üî¥ Ready
                </span>
            </h3>

            <div style="overflow-x: auto; background: rgba(255, 255, 255, 0.02); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05);">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: rgba(255, 255, 255, 0.05);">
                            <th style="padding: 16px; text-align: left; color: #94a3b8; font-weight: 500; font-size: 0.9rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Time</th>
                            <th style="padding: 16px; text-align: left; color: #94a3b8; font-weight: 500; font-size: 0.9rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Type</th>
                            <th style="padding: 16px; text-align: left; color: #94a3b8; font-weight: 500; font-size: 0.9rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">SOL Amount</th>
                            <th style="padding: 16px; text-align: left; color: #94a3b8; font-weight: 500; font-size: 0.9rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Signature</th>
                            <th style="padding: 16px; text-align: left; color: #94a3b8; font-weight: 500; font-size: 0.9rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">Accounts</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTable">
                        <tr>
                            <td colspan="5" style="padding: 40px; text-align: center; color: #94a3b8; font-style: italic;">
                                ‚è≥ Enter a token address above to start monitoring...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 16px; text-align: center;">
                <span style="font-size: 0.8rem; color: #64748b;">Showing last 50 transactions ‚Ä¢ Updates every 10 seconds</span>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const connectionStatus = document.getElementById('connectionStatus');
        const totalTransactions = document.getElementById('totalTransactions');
        const buyOrders = document.getElementById('buyOrders');
        const sellOrders = document.getElementById('sellOrders');
        const uptime = document.getElementById('uptime');
        const lastUpdated = document.getElementById('lastUpdated');
        const liveStatus = document.getElementById('liveStatus');
        const currentToken = document.getElementById('currentToken');
        const tokenInput = document.getElementById('tokenInput');
        const setTokenBtn = document.getElementById('setTokenBtn');
        const transactionTable = document.getElementById('transactionTable');

        let transactionCount = 0;
        const maxTransactions = 10; // Only show last 10 transactions
        let lastUpdateTime = null;

        // Heartbeat to track if bot is alive
        let heartbeatInterval;
        let lastHeartbeat = null;

        // Connection status
        socket.on('connect', () => {
            connectionStatus.textContent = 'üü¢ Connected';
            connectionStatus.className = 'connection-status connected';
            console.log('WebSocket connected');
            startHeartbeat();
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'üî¥ Disconnected';
            connectionStatus.className = 'connection-status disconnected';
            console.log('WebSocket disconnected');
            stopHeartbeat();
            liveStatus.textContent = 'üî¥ Monitoring paused';
        });

        // Bot status updates
        socket.on('bot-status', (data) => {
            console.log('Bot status:', data);
            if (data.targetToken) {
                currentToken.textContent = data.targetToken.substring(0, 8) + '...';
                tokenInput.value = data.targetToken;
            }
            updateLiveStatus('üü¢ Bot Active');
        });

        // Heartbeat response from server
        socket.on('heartbeat-response', () => {
            lastHeartbeat = Date.now();
            liveStatus.textContent = 'üü¢ Live Monitoring';
        });

        // Transaction updates - show ALL transactions
        socket.on('transaction', (data) => {
            console.log('Received transaction:', data);
            transactionCount++;
            totalTransactions.textContent = transactionCount;
            updateLastUpdated();

            // Show all transactions
            addTransactionToTable(data);
        });

        socket.on('buy-detected', (data) => {
            buyOrders.textContent = parseInt(buyOrders.textContent) + 1;
            updateLastUpdated();
        });

        socket.on('sell-executed', (data) => {
            sellOrders.textContent = parseInt(sellOrders.textContent) + 1;
            updateLastUpdated();
        });

        function startHeartbeat() {
            heartbeatInterval = setInterval(() => {
                // Send heartbeat to check if connection is alive
                socket.emit('heartbeat');
                updateLastUpdated();

                // If no heartbeat received in 15 seconds, show as paused
                if (lastHeartbeat && (Date.now() - lastHeartbeat) > 15000) {
                    liveStatus.textContent = 'üî¥ Monitoring paused';
                } else {
                    liveStatus.textContent = 'üü¢ Live Monitoring';
                }
            }, 5000);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
        }

        function updateLiveStatus(status) {
            liveStatus.textContent = status;
            lastHeartbeat = Date.now();
        }

        function updateLastUpdated() {
            const now = new Date();
            lastUpdated.textContent = now.toLocaleTimeString();
            lastUpdateTime = now;
        }

        // Set token functionality
        setTokenBtn.addEventListener('click', () => {
            const tokenAddress = tokenInput.value.trim();
            if (!tokenAddress) {
                alert('Please enter a token address');
                return;
            }

            // Validate token address (basic check)
            if (tokenAddress.length < 32) {
                alert('Invalid token address - should be at least 32 characters');
                return;
            }

            // Send token change request
            fetch('/api/change-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tokenAddress: tokenAddress })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentToken.textContent = tokenAddress.substring(0, 8) + '...';
                    // Clear table and show waiting message
                    transactionTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="padding: 40px; text-align: center; color: #10b981; font-style: italic;">
                                üîÑ Monitoring token: ${tokenAddress.substring(0, 8)}...
                            </td>
                        </tr>
                    `;
                    alert('Token updated successfully!');
                } else {
                    alert('Failed to update token: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error changing token:', error);
                alert('Error changing token: ' + error.message);
            });
        });

        // Allow Enter key to set token
        tokenInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                setTokenBtn.click();
            }
        });

        function addTransactionToTable(tx) {
            // Remove initial message if it exists
            const initialRow = transactionTable.querySelector('tr td[colspan="5"]');
            if (initialRow && initialRow.textContent.includes('Enter a token address')) {
                transactionTable.innerHTML = '';
            }

            // Create table row
            const row = document.createElement('tr');
            row.style.cssText = 'border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: background 0.2s;';

            // Add hover effect
            row.addEventListener('mouseenter', () => {
                row.style.background = 'rgba(255, 255, 255, 0.03)';
            });
            row.addEventListener('mouseleave', () => {
                row.style.background = 'transparent';
            });

            const time = new Date(tx.timestamp).toLocaleTimeString();
            const solAmount = tx.solAmount > 0 ? `${tx.solAmount.toFixed(6)}` : '-';
            const accounts = tx.accounts || 0;
            const shortSig = tx.signature ? tx.signature.substring(0, 16) + '...' : 'N/A';

            row.innerHTML = `
                <td style="padding: 12px 16px; color: #e2e8f0; font-size: 0.9rem;">${time}</td>
                <td style="padding: 12px 16px;">
                    <span style="display: inline-flex; align-items: center; gap: 4px; font-weight: 500; font-size: 0.9rem;">
                        ${getTransactionEmoji(tx.transactionType)}
                        ${tx.transactionType?.toUpperCase() || 'UNKNOWN'}
                    </span>
                </td>
                <td style="padding: 12px 16px; color: #fbbf24; font-weight: 500; font-size: 0.9rem; font-family: monospace;">${solAmount}</td>
                <td style="padding: 12px 16px;">
                    <span style="font-family: monospace; font-size: 0.8rem; color: #64748b; background: rgba(255, 255, 255, 0.05); padding: 4px 8px; border-radius: 4px;">
                        ${shortSig}
                    </span>
                </td>
                <td style="padding: 12px 16px; color: #94a3b8; font-size: 0.9rem;">${accounts}</td>
            `;

            // Add to top of table
            transactionTable.insertBefore(row, transactionTable.firstChild);

            // Limit to 50 transactions
            const rows = transactionTable.querySelectorAll('tr');
            if (rows.length > 50) {
                rows[rows.length - 1].remove();
            }
        }

        function getTransactionEmoji(type) {
            switch (type) {
                case 'buy': return 'üü¢';
                case 'sell': return 'üî¥';
                case 'pump': return '‚ö°';
                case 'monitor': return 'üîç';
                default: return 'üìÑ';
            }
        }

        // Update uptime every second
        setInterval(() => {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    uptime.textContent = formatUptime(data.uptime);
                })
                .catch(() => {
                    console.log('Could not fetch uptime');
                });
        }, 1000);

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        // Initial status check
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                console.log('Initial status:', data);
            })
            .catch(() => {
                console.log('Could not load initial status');
            });
    </script>
</body>
</html>
